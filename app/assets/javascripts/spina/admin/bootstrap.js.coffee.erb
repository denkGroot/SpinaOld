# Bootstrapping all of Spina
ready = ->

  # Scroll
  setTimeout ->
    window.scrollTo(0)
  , 50

  # Select boxes
  $('select').select_skin()

  # Gallery select
  $('.gallery-select').galleryselect()

  # Datepicker
  $('input[data-datepicker]').datepicker
    dateFormat: 'dd MM yy',
    onClose: (dateText, inst) ->
      $(inst.input).change().focusout()

  # Fast buttons
  $('a.button:not(#nav-trigger)').addClass('fastbutton')

  # File input
  $('input[data-customfile]').each ->
    $(this).customFileInput()

  # Loading footable
  $('.footable').footable()

  # Loading switches
  $('input[data-switch]').spinaSwitch()

  # Load login form
  $('#login_wrapper').css('margin-top', ($(document).innerHeight() / 2) - ($('#login_wrapper').innerHeight() / 2) + 'px')

  # Loading epiceditor
  $('.epiceditor').each ->
    textarea = $(this)
    textarea.hide()
    id = 'editor_' + $(this).attr("id")
    textarea.parent().prepend("<div id=#{id} style='height: 400px' />")

    editor = new EpicEditor(
      container: id
      basePath: '/assets/spina/admin'
      clientSideStorage: false
      theme:
        base: "/epiceditor/base.css"
        preview: "/epiceditor/preview.css"
        editor: "/epiceditor/editor.css"

    ).load()
    editor.importFile('file', textarea.val())
    
    $(editor.getElement('wrapper')).find('.epiceditor-help-btn').on 'click', ->
      modal = '
        <div id="modal" class="modal modal-large">
          <header class="big-header">
            <a href="#" class="close_modal" data-dismiss="modal"><i class="icon-only" data-icon="x"></i></a>

            <h3>Markdown Help</h3>

          </header>
          <section>
<div class="col">
  <h3>Tekst Opmaak</h3>
  <p>Kopteksten</p>
  <pre># Dit is een &lt;h1&gt; tag\n
## Dit is een &lt;h2&gt; tag\n
###### Dit is een &lt;h6&gt; tag</pre>
  <p>Tekst Stijlen</p>
  <pre>*Deze tekst is cursief*\n
_Deze tekst is ook cursief_\n
**Deze tekst is vet**\n
__Deze tekst is ook vet__\n
\n
*Je **kunt** ze combineren*\n
</pre>
</div>


<div class="col">
  <h3>Lijsten</h3>
  <p>Ongeorderd</p>
  <pre>* Item 1\n
* Item 2\n
  * Item 2a\n
  * Item 2b</pre>
  <p>Georderd</p>
<pre>1. Item 1\n
2. Item 2\n
3. Item 3\n
   * Item 3a\n
   * Item 3b</pre>
</div>

<div class="col">
  <h3>Overig</h3>
  <p>Afbeeldingen</p>
  <pre>![Google Logo](/images/google.png)\n
Opmaak: ![Alt Text](url)\n
</pre>\n
  <p>Links</p>\n
  <pre>http://google.com - automatic!\n
[Google](http://google.com)</pre>
  <p>Vimeo Videos, de video_id kun je vinden in de url van de video.</p>
  <pre>[vimeo 40977797]\n
Opmaak: [vimeo video_id]</pre>
  <p>Blockquotes</p>
 <pre>Zoals Kanye West heeft gezegd:\n
\n
&gt; We\'re living the future so\n
&gt; the present is our past.\n
</pre>
</div>

          </section>
          <footer>
              <a href="#" data-dismiss="modal" data-icon="v" style="width: 100%; -webkit-box-shadow: none; border-left: none">Oké, begrepen</a>
            </footer>
        </div>
      '
      $(modal).modal()

    editor.on 'save', ->
      textarea.val(editor.exportFile())



  # Photo upload
  $('#new_photo').fileupload
    dataType: "script"
    limitMultiFileUploads: 10
    add: (e, data) ->
      types = /(\.|\/)(gif|jpe?g|png)$/i
      file = data.files[0]
      if types.test(file.type) || types.test(file.name)
        data.context = $(tmpl("template-upload", file))
        $('#uploads').append(data.context)
        data.submit()
      else
        modal = '
          <div id="modal" class="modal">
            <header class="big-header">
              <a href="#" class="close_modal" data-dismiss="modal"><i class="icon-only" data-icon="x"></i></a>
              <h3><strong>' + file.name + '</strong> is geen afbeelding.</h3>
            </header>
            <footer>
                <a href="#" data-dismiss="modal" data-icon="v" style="width: 100%; -webkit-box-shadow: none; border-left: none">Oké, begrepen</a>
              </footer>
          </div>
        '
        $(modal).modal()

    progress: (e, data) ->
      if data.context
        progress = -(parseInt(data.loaded / data.total * 100, 10) - 100)
        progress = 20 if progress < 20
        data.context.find('.upload-cloud-processing').css('height', progress + '%')

  $('#new_photo input').hover ->
    $("#uploadbutton").addClass('hover')
  , ->
    $("#uploadbutton").removeClass('hover')

  # Colorpickers
  $('.colorpicker').each ->
    colorpicker = $(this).find('.colorpicker-container')
    field = $(this).find('input')

    $.farbtastic colorpicker, (color) ->
      field.val(color)
      field.css('color', color)

  $('.colorpicker input').focus ->
    container = $(this).parent()
    colorpicker = container.find('.colorpicker-container')
    $.farbtastic(colorpicker).setColor($(this).val())
    container.find('.farbtastic').show()

  $('.colorpicker input').blur ->
    container = $(this).parent()
    container.find('.farbtastic').hide()

  $('form').on 'click', '.remove_fields', (e) ->
    $(this).parent().find('input[type=hidden]').val('1')
    $(this).closest('fieldset').hide()
    e.preventDefault()

  $('form').on 'click', '.add_fields', (e) ->
    time = new Date().getTime()
    regexp = new RegExp($(this).data('id'), 'g')
    $(this).before($(this).data('fields').replace(regexp, time))
    $(this).parent().find('input[type=file]').last().customFileInput()
    e.preventDefault()

$(document).ready(ready)
$(document).on('page:load', ready)